---
layout: post
title: 4천만 MAU 를 지탱하는 서비스 설계와 데이터 처리 기술 강의 메모
date: 2023-03-19 20:30:00 + 0900
categories: Architecture
ref: DB, MAU, Service, Sharding, Architecture, Transaction
---

# 4천만 MAU 를 지탱하는 서비스 설계와 데이터 처리 기술 강의 메모

## 1. 대규모 서비스에서 발생하는 기술적 이슈 및 장애 사례
### 1-1. IT 서비스 혁신 = 비즈니스 모델의 혁신 ∋ 기술의 혁신
```
{기술 발전}이나 {소비자 욕구 변화}에 따라 혁신적인 {제품 또는 서비스}를 제공
aws - {가상화 기술 발전}과 {합리적 소비 확산}에 따라 혁신적인 {컴퓨팅 클라우드 서비스}를 제공
	-> 가상화 컴퓨팅 파워를 온라인 pay-per-use 방식으로 유통해 글로벌 서버 시장 장악
여기어떄 - {위치 기반 기술}과 {온라인 예약 확산}에 따라 혁신적인 {숙박, 레저 서비스}를 제공
	-> 위치 기반 기술을 사용해 사용자에 인접한 객실 상품을 유통해 숙박 예약 시장 장악
그런데 인터넷 스케일(인터넷 고객 트래픽)을 만나면,
	{기술 발전} - 확장성이 없는 디자인 ...
	{소비자 욕구 변화} - Push 발소에 따른 먹통, 빈번한 예약장애, 매출 분석의 불편함 ...
	{제품 또는 서비스} - 느린 앱 성능
	-> 숙박 예약 시장 장악 실패
	이런 현상을 "기술 부채" 라고 함
```	
### 1-2. 기술부채가 야기하는 문제들
```
기능 요구사항은 통과하는데 뭔가 잘못 짜여진 코드가 관리가 안될 떄까지 계속 불어나는 것
- 속도
	스프린트 당 처리되는 Task 수가 크게 감소
	-> 생산성 저하
- 스트레스
	개발팀의 일상적인 스트레스
	-> 잦은 퇴사
- 프로덕션
	수정 후에도 문제가 계속 발생
	-> 브랜드 이미지 실추
- 품질 
	릴리스 당 버그 수가 빠르게 증가
	-> 서비스 품질 저하
```
### 1-3. 기술 부채의 경고 징후
```		
너무 데이터베이스에 의존적인 경우 절망적인 쿼리가 서서히 자란다
개발 부서가 시장 요구 사항(APIs)과 빈번희 변화하는 사업 요구사항(Back Office)을 들어주려다 보니 발생함
예시
	예약 내역 테이블
	요구사항) 관리툴에서 지난 4년간 매출을 월 단위로 볼수 있게 해주세요.
	Table: reservationTable / 예약 내역 테이블 4년간 예약 건수가 1억 5천건
	[Reserve ID	|	Cust ID	|	Payment	|	Item ID	|	Date]
	단일 쿼리로 추출 시)
		SELECT date_format(date, '%M-%Y') as sdate, sum(payment) as 'netsales'
		FROM reservationTable
		WHERE year(sdate) = year('2016-01-01')
		GROUP BY year(sdate), month(sdate)
		ORDER BY year(sdate), month(sdate)
		-> Payment, Date 컬럼 풀스캔 해야함
		-> 쿼리 수행 시간은 1s 내로 떨어지기 어려움
			data[][] = {
				{ 0, 1 },
				{ 1, 4 },
				{ 0, 2 },
				{ 2, 3 }
			}
			
			1) Group By 
				Map<Integer, List<Integer>> = {
					{ 0, { 1, 2 }},
					{ 1, { 4 }},
					{ 2, { 3 }}
				}
			
			2) Summation
				Output[][] output;
				Map.forEatch((k, v) -> {
					int sum = 0;
					v.forEach(e -> {
						sum += e;
					});
					output[k][0] = k;
					output[k][1] = sum;
				});
				
				output:
					{ 0, 3 },
					{ 1, 4 },
					{ 2, 3 }
			
			3) Sort
	
			복잡도)
				공간 복잡도: 15 * 10^7 * 4 bytes(Payment) * 10 bytes(Date) = 6GB
				시간 복잡도: O(NM)(Summation) + O(KlogK)(Sort)
				-> 1s 내에 해결할 수 있는 쿼리가 아님. 몇 십분이 걸릴 수 있다
	해결 방법)
		느린 쿼리를 새벽마다 배치로 돌리고 쿼리 결과를 테이블에 담는다.
		날짜를 기준으로 해당 월의 매출의 집계를 계산해서 결과를 결과 테이블에 추가한다.
			[MM	|	SUM], 4 * 12 row
		월 단위 매출 조회는 결과 테이블을 대상으로 한다.
		-> Materialized View 방식이라고 한다. 일종의 캐시 방식
	
	한계점)
		배치 쿼리가 도는 동안, 결제 대금 취소 또는 재결제, 즉 DELETE 나 UPDATE 처리가 동시에 일어나면?
		조회한 매출 결과가 실제 결과와 약간 다를 수 있다. 
		더 큰 문제는 예약 내역 테이블이 다른 테이블과 심오하게 관계를 맺고 있거나 너무 많은 배치 쿼리들이 돌아가고 있는 것이다.
			-> 기술부채, 알 수 없는 곳에서 문제가 터지고 관리가 안된다.
어떻게 극복할 수 있나?
            문제                           |             원인			
	서비스 장애와 성능 이슈                  |       알고리즘과 자료구조 역량
	트래픽 대응 및 유지보수의 어려움         |   	확장성 있는 설계, 소프트웨어 디자인 역량
	제품 품질을 위한 매뉴얼 운영 인력의 증가  | 	사람 대신 기계, 데이터 활용 역량
```

## 2. 확장성 있는 시스템 설계와 소프트웨어 디자인이란?

### 2-1. 확장성과 안정성 있는 서비스 시스템 설계 패턴
```
yahoo 구조
	client								server					DB
	http://yahoo.com			-->		Apache + Perl CGI		61.72.103.108
	DNS lookup 61.72.103.24				61.72.103.24
	
	이 구조에서 웹서버에 장애 발생 시 모든 서비스가 중단됨.
	DB 에서 장애가 나도 똑같이 모든 서비스가 중단됨.
	-> 서비스 안정성, 확장성이 떨어진다. 단일 장애 구간(Single Point of Failure)
	
	아래 구조로 단일 장애 구간 해소
	client			L4				server						DB
					요청		\/		Apache + Per CGI #1		\/	Primary DB
					분산		/\		Apache + Per CGI #2		/\	Secondary DB
					
	웹서버나 DB 에 장애가 나도 서비스는 살아 있다.
```

```
확장성이란?
	Server-level Scalability
		서버 측 요청 수 증가에 따라 서버 확장이 용이한가?
			소프트웨어 스택 선정
			데이터베이스 설계
			시스템 아키텍처
			배포 관리
	Code-level Scalability
		새로운 요구사항에 대해 코드 변경이 용이한가?
			언어 선정
			테이블 설계
			디자인 패턴
			버전 관리
```

```
웹서버는 확장이 용이하지만 DB 는 확장이 어렵다.
	네트워크로 연결된 공유 스토리지를 활용하기도 한다
		DB Instance #1	\ 		
						 >	SAN Storage
		DB Instance #2	/ 
		SAN Storage 는 SPOF 이지만 매우 고가의 장비라서 큰 장애를 만든 경력이 없다.
	웹서버의 확장이 용이한 이유
		서로 아무것도 공유하지 않는 구조이다(Stateless)
	데이터베이스의 확장이 어려운 이유
		데이터베이스는 공유 자원이고 데이터 관계의 복잡도 때문
```

```
요즘은 샤딩으로 트래픽을 분산함
	client			L4				server									DB
					요		\  /	Apache + Per CGI #1		--	H	\  /	Shard #1(A~D)
					청		 \/		Apache + Per CGI #2		--	A	 \/		Shard #2(E~O)
					분		 /\		Apache + Per CGI #3		--	S	 /\		Shard #3(P~U)
					산		/  \	Apache + Per CGI #4		--	H	/  \	Shard #4(V-Z)
	샤딩을 하고 각 샤드를 Active-StandBy 로 HA 구성을 해줘야 함				
	대다수의 인터넷 서비스가 가진 아키텍처
```

```
스트리밍이나 채팅 서버 같은 서비스는 L4 의 라운드로빈 방식으로 트래픽을 분산해도 로드밸런싱이 되지 않는다.
	계속 오랫동안 유지되는 트래픽이기 때문에 시간이 지나면 한 곳에 몰려 있을 수 있다.
```