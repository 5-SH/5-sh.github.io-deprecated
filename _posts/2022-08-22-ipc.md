---
layout: post
title: IPC(Inter Process Communication)
date: 2022-08-06 02:00:00 + 0900
categories: OS
ref: OS, ipc, shared memory, pipe, socket, rpc, data_seg pragma
---

# IPC(Inter Process Communication)

## 1. 메모리를 활용한 방법

### 1-1. shared memory
  - 할당된 공유 메모리의 크기는 고정됩니다.
  - 다른 두 프로세스의 VMS 가 RAM 의 같은 물리적 위치를 공유합니다.
  - 생성된 공유 메모리는 커널에 의해 관리됩니다.
  - 공유 메모리 영역을 사용하는 모든 프로세스가 종료 되어도 재부팅 하거나 직접 해제하지 않는 이상 유지됩니다.   
    shmctl() 시스템 콜을 통해 공유 메모리를 제거할 수 있습니다. 
  - 커널에 의해 공유 메모리 영역이 생성되면 shmat() 시스템 콜을 통해   
    각 프로세스 메모리의 데이터 영역에 attach 됩니다.

```c
// writer.c
#include <stdio.h>
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/shm.h>

#define KEY_NUM 3306
#define MEM_SIZE 1024

int main(void) 
{
  int shm_id;
  void *shm_addr;
  int count;

  /**
  int shmget(key_t key, int size, int shmflg)

  create shared memory by kernel but not yet available by process
  @param key    : identifier for shared memory
  @param size   : size of memory
  @param shmflg : options
                  IPC_CREAT - if hared mem not exists, create
                  IPC_EXCL  - if already exists, failed
  @return       : failed - -1 or identifier
  */

  shm_id = shmget((key_t)KEY_NUM, MEM_SIZE, IPC_CREAT | 0666);

  if (shm_id == -1) 
  {
    perror("shmget error : ");
    return 0;
  }

  /**
  void* shmat(int shmid, const void* shmaddr, int shmflg)
  
  After create the shared memory by kernel,
  need to attach this memory to the process to use this shared meemory
  @param shmid    : identifier for shared memoery
  @param shmaddr  : address for this memory segment
                    if 0, kernel will do it
  @param shmflg   : options 
                    SHM_RONLY - read only
  @return         : failed -1 or the address of shared memory attached to process
  */
  shm_addr = shmat(shm_id, (void *)0, 0);

  if ((void *)-1 == shm_addr)
  {
    perror("shmat error : ");
    return 0;
  }

  printf("Shared memory address : %p\n", shm_addr);

  count = 0;
  while (1) 
  {
    sprintf((char *)shm_addr, "%d", count++);
    sleep(1);
  }

  return 0;
}
```

```c
// reader.c
#include <stdio.h>
#include <unistd.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/types.h>

#define KEY_NUM 3306
#define MEM_SIZE 1024

int main(void) 
{
  int shm_id;
  void *shm_addr;

  if (-1 == (shm_id = shmget((key_t)KEY_NUM, MEM_SIZE, IPC_CREAT | 0666)))
  {
    printf("공유 메모리 생성 실패\n");
    return -1;
  }

  if((void *) -1  == (shm_addr = shmat(shm_id, (void *)0, 0)))
  {
    printf("공유 메모리 첨부 실패\n");
    return -1;
  }

  printf("start address of shared memory : %p\n", shm_addr);

  while(1)
  {
    printf("Data read from shared mem : %s\n", (char *)shm_adr);
    sleep(1);
  }

  return 0;
}
```