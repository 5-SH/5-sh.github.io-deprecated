---
layout: post
title: 오프라인 동시성 패턴 (1)
date: 2022-07-13 15:30:00 + 0900
categories: Patterns
ref: Patterns, concurrency, lock
---

# 오프라인 동시성 패턴 (1)
## 1. 낙관적 오프라인 잠금
충돌이 감지되면 트랜잭션을 롤백해 동시 비즈니스 트랜잭션 간의 충돌을 방지한다.

<figure>
  <img src="https://user-images.githubusercontent.com/13375810/178661312-4ea92dbb-d330-45bd-a166-1e42d4e70da0.jpg" width="75%"/>
  <figcaption></figcaption>
</figure>

### 1-1
비즈니스 트랜잭션은 여러 시스템 트랜잭션을 거쳐 실행되는 경우가 많습니다.   
비즈니스 트랜잭션이 시스템 트랜잭션 범위를 벗어나면 데이터베이스의 도움만으로   
레코드 데이터를 일관된 상태로 유지할 수 없습니다.   

낙관적 오프라인 잠금은 한 세션에서 커밋하려는 변경 내용이 다른 세션의 변경 내용과    
충돌하지 않는지 확인하는 방법으로 이 문제를 해결합니다.    

낙관적 오프라인 잠금은 세션 충돌 가능성이 낮다고 간주하고    
여러 사용자가 동시에 동일한 데이터를 가지고 작업하도록 허용합니다.   
하지만 비즈니스 트랜잭션이 커밋될 것인지 여부를    
마지막 시스템 트랜잭션이 되어서야 알려줍니다.

세션 충돌의 가능성이 높을 것으로 예상되면 시스템의 동시성을 제한하는    
비관적 오프라인 잠금을 사용하는 것이 낫습니다.

### 1-2
낙관적 오프라인 잠금은 세션이 레코드를 로드한 이후    
다른 세션이 이를 변경하지 않은 것을 확인함으로써 획득할 수 있습니다.    

낙관적 오프라인 잠금을 구현하는 가장 일반적인 방법은 각 레코드에 버전 번호를 연결하는 것 입니다.   
낙관적 오프라인 잠금을 얻는다는 것은 __세션 데이터에 저장된 버전을    
레코드 데이터의 현재 버전과 비교하는 것__ 을 의미합니다.   

레코드 데이터의 현재 버전과 세션 데이터에 저장된 버전이 같다면   
레코드 데이터에 대한 변경을 진행해도 좋다는 의미의 잠금을 얻는 것 입니다.    
이 과정을 __유효성 검사__ 라고 부릅니다.    

유효성 검사가 성공하면 버전 증가를 비롯한 모든 변경을 커밋할 수 있습니다.    
버전 증가는 인전 버전을 가진 세션이 잠금을 얻을 수 없게 함으로써    
레코드 데이터의 일관성을 보호합니다.   

### 1-3
RDBMS 를 사용하는 경우 유효성 검사는 레코드 업데이트 또는 삭제하는 쿼리문에   
조건을 추가하는 것으로 구현할 수 있습니다.   
쿼리문 하나에서 잠금을 얻고 레코드 데이터를 업데이트 할 수 있습니다.   

그리고 쿼리문 실행 결과로 반환된 행 카운트를 검사해 0인 경우   
비즈니스 트랜잭션은 시스템 트랜잭션을 롤백해 변경사항이 레코드 데이터에 적용되지 않게 합니다.    

각 레코드에 버전 번호와 함께 마지막으로 수정한 사용자와 시간에 대한 정보를 저장하면   
동시성 충돌을 관리하는데 요유용하게 사용할 수 있습니다.    

### 1-4
UPDATE 와 DELETE 쿼리에 버전을 추가하는 방법을 많이 사용하지만,   
이 경우 일관성 없는 읽기 문제가 발생할 수 있습니다.   

청구서를 생성하고 소비세를 계산하는 청구 시스템을 예로 들면,   
한 세션이 청구서를 생성하고 세금을 계산하기 위해 해당 고객의 주소를 조회하는 동안   
별도의 고객 유지 관리 세션이 고객의 주소를 편집할 수 있습니다.   

세율은 고객의 주소지에 따라 다르므로 청구서 생셩 세션이 계산한 세율이 틀릴 수 있습니다.   
그러나 청구서 생성 세션은 UPDATE 또는 DELETE 쿼리를 사용하지 않았기 때문에   
주소지 레코드에 대한 충돌을 감지하지 못합니다.   

비즈니스 로직에서 고객의 주소 값이 중요하다는 것을 알았다면,   
주소를 변경 집합에 추가하거나 버전 검사를 수행할 항목의 목록을 별도로 유지하는 등의 방법으로   
중요한 값에 대한 버전 검사를 추가로 수행해야 합니다.   

버전 검사를 수행할 때,    
UPDATE 또는 DELETE 쿼리가 아니라 SELECT 쿼리로 버전을 다시 읽는 방법을 사용해 검사하는 경우    
시스템 트랜잭션 격리 수준을 REPEATABLE READ 이상으로 설정해야 합니다.   

